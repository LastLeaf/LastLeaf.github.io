"use strict";var WIDTH=960,HEIGHT=540,ME_R=12,LIGHT_R_MAX=300,ME_HP_MAX=[5e3,2e3,1e3,700],LIGHTS_SPEED=[2,2.5,3,3.5],P_STATE_CHANGE=[.025,.03,.035,.04],ME_MOVE_SPEED=3,ME_ACTION_SPEED=6,ME_ACTION_DAMAGE=4,ME_ACTION_DIF=Math.PI/8,ME_DAMAGE_PER_R=1,parseMap=function(e){var t={},a=game.maps[e].split("|");t.startX=6*a[1],t.startY=6*a[2];var r=a[3].split(" "),s=a[4].split(" "),n=Math.floor(Math.random()*r.length);t.endX=6*r[n],t.endY=6*s[n],t.showEnd=!1,("S"===s[r.length]||"SW"===s[r.length])&&(t.showEnd=!0),t.alwaysShowEnd=!1,"A"===s[r.length]&&(t.alwaysShowEnd=!0),t.white=!1,("W"===s[r.length]||"SW"===s[r.length])&&(t.white=!0),t.lights=[];for(var i=a[5].split(" "),n=0;n<i.length;n++){var c=i[n].match(/^\(([0-9]+)\,([0-9]+)\)\*([0-9]+)\(([0-9]+)\,([0-9]+)\)(o[0-9]+|)(~[0-9\.]+|)$/);c&&(c[6]=c[6]?6*Number(c[6].slice(1)):0,c[7]=c[7]?Number(c[7].slice(1)):1,t.lights.push({x:6*c[1],y:6*c[2],r:6*c[3],xori:6*c[1],yori:6*c[2],rori:6*c[3],rmin:6*c[4],rmax:6*c[5],area:c[6],speed:c[7],moveX:0,moveY:0,sizeState:0}))}for(var i=a[0],o=new Array(14400),l=new createjs.Shape,u=l.graphics.f("rgb(128,128,128)"),n=0;2400>n;n++)for(var d=i.charCodeAt(n)-48,g=5;g>=0;g--){var h=6*n+g;o[h]=!(d%2),d>>=1,o[h]&&u.r(6*(h%160),6*Math.floor(h/160),6,6)}return l.filters=[new createjs.BoxBlurFilter(12,12,1)],t.white?l.cache(24,24,WIDTH-48,HEIGHT-48):l.cache(0,0,WIDTH,HEIGHT),t.block=o,t.picture=l,t},generateRound=function(e,t,a){var r=new createjs.Shape,s=(t+a)/2,n=a-s;return r.graphics.f(e).arc(0,0,s,0,2*Math.PI),r.filters=[new createjs.BoxBlurFilter(n,n,1)],r.cache(-a,-a,2*a,2*a),r},lightCache=new Array(LIGHT_R_MAX+1),generateLight=function(e,t,a){var r=5,s=5;if(lightCache[e])return lightCache[e].clone().set({x:t-s-1-e,y:a-s-1-e});for(var n=new createjs.Graphics,i=e+s;i>=e-r;i--)n.f("rgba(255,255,255,"+.025*(e+s-i)+")").arc(0,0,i,0,2*Math.PI);var c=new createjs.Shape(n);return c.cache(-(e+s+1),-(e+s+1),2*(e+s+1),2*(e+s+1)),lightCache[e]=new createjs.Bitmap(c.cacheCanvas),lightCache[e].clone().set({x:t-s-1-e,y:a-s-1-e})},generatePerson=function(e){for(var t=new createjs.SpriteSheetBuilder,a=.75*ME_R,r=.25*ME_R,s=1.25*ME_R,n=(a-r)/40,i=41,c=new createjs.Rectangle(1-s,1-s,2*(s-1),2*(s-1)),o=a;o>r-1e-6;o-=n)t.addFrame(generateRound(e,o,s),c);for(var l=[],o=0;i/2>o;o++)l.push(o);for(var o=Math.floor(i/2)-2;o>0;o--)l.push(o);t.addAnimation("normal",l,"normal");for(var l=[],o=0;i>o;o+=8)l.push(o);for(var o=i-4;o>0;o-=8)l.push(o);return t.addAnimation("fast",l,"fast"),new createjs.BitmapAnimation(t.build())},whiteMap=function(){var e=new createjs.Shape;return e.graphics.f("rgb(128,128,128)").r(12,12,WIDTH-24,HEIGHT-24),e.filters=[new createjs.BoxBlurFilter(12,12,1)],e.cache(0,0,WIDTH,HEIGHT),e}(),userCtrlReset=function(){userCtrl.paused=!1,userCtrl.skip=!1,userCtrl.reset=!1,userCtrl.action=!1,userCtrl.up=!1,userCtrl.down=!1,userCtrl.left=!1,userCtrl.right=!1},userCtrl={paused:!1,reset:!1,skip:!1,action:!1,up:!1,down:!1,left:!1,right:!1},pause=function(){userCtrl.paused=!0},unpause=function(){userCtrl.paused=!1},startLevel=function(e){if(!game.maps[e]){game.curMusic=-1;var t=1,a=function(){t-=.04,game.settings.musicOn&&createjs.Sound.setVolume(t*game.settings.volume/100),0>=t&&(e>=0&&(game.settings.curLevel=0,game.saveSettings()),game.started=!1,createjs.Sound.stop(),createjs.Ticker.removeAllEventListeners("tick"),MOBILE&&game.mouseFuncRemove(),window.removeEventListener("keydown",game.keyDownFunc),window.removeEventListener("keyup",game.keyUpFunc),game.showCover())};return createjs.Ticker.addEventListener("tick",a),void 0}if(game.curMusic!==game.words[e].chapter){var t=1,r=function(){if(t-=.04,0>=t){switch(t=0,createjs.Sound.stop(),game.curMusic=game.words[e].chapter,game.curMusic){case 1:createjs.Sound.play("bgm1",createjs.Sound.INTERRUPT_ANY,0,0,-1);break;case 2:createjs.Sound.play("bgm2",createjs.Sound.INTERRUPT_ANY,0,0,-1);break;case 3:createjs.Sound.play("bgm3",createjs.Sound.INTERRUPT_ANY,0,0,-1);break;default:createjs.Sound.play("bgm4",createjs.Sound.INTERRUPT_ANY,0,0,-1)}createjs.Ticker.removeEventListener("tick",r),createjs.Ticker.addEventListener("tick",s),n()}game.settings.musicOn?createjs.Sound.setVolume(t*game.settings.volume/100):createjs.Sound.setVolume(0)},s=function(){t+=.02,t>=1&&(t=1,createjs.Ticker.removeEventListener("tick",s)),game.settings.musicOn?createjs.Sound.setVolume(t*game.settings.volume/100):createjs.Sound.setVolume(0)};createjs.Ticker.addEventListener("tick",r)}else setTimeout(function(){n()},1e3);var n=function(){var t=game.words[e].story,a=new createjs.Text;a.textAlign="center",a.textBaseline="middle",a.x=WIDTH/2,a.y=HEIGHT/2,a.filters=[new createjs.BoxBlurFilter(1,1,1)],a.cache(-480,-20,960,40);var r=new createjs.Container;game.stage.addChild(r);var s=0,n=!0,i=-1,o=.04,l=1.25,u=.05;r.alpha=-1;var d=1;userCtrl.skip=!1;var g=function(e){for(var t=0,a=0;a<e.length;a++)e.charCodeAt(a)<128?t++:t+=3;return t*u+l},h=function(){if((s>=t.length||userCtrl.skip)&&(userCtrl.skip=!1,s>=t.length||game.settings.levelReached>=e))return createjs.Ticker.removeEventListener("tick",h),game.stage.removeChild(r),c(),void 0;if(n){if(r.alpha<=i)if(r.removeAllChildren(),"!"===t[s].charAt(0))if("!img:"===t[s].slice(0,5)){d=2.5;var l=game.mainResource.getResult(t[s].slice(5));r.addChild(new createjs.Bitmap(l).set({x:(WIDTH-l.width)/2,y:(HEIGHT-l.height)/2}))}else"!author:"===t[s].slice(0,8)?(a.font="24px"+game.lang.font,a.lineHeight=36,a.color="#c0c0c0",a.text=t[s].slice(8),a.cache(-480,-60,960,120),d=.7*g(t[s]),r.addChild(a)):"!her:"===t[s].slice(0,5)&&(a.font=game.lang.storyFontSize+"px"+game.lang.font,a.lineHeight=1.5*game.lang.storyFontSize,a.color="#FBB7BF",a.text=t[s].slice(5),a.cache(-480,-30,960,60),d=g(t[s]),r.addChild(a));else a.font=game.lang.storyFontSize+"px"+game.lang.font,a.lineHeight=1.5*game.lang.storyFontSize,a.color="#c0c0c0",a.text=t[s],a.cache(-480,-30,960,60),d=g(t[s]),r.addChild(a);r.alpha+=o,r.alpha>=d&&(n=!1)}else r.alpha-=o,r.alpha<=i&&(n=!0,s++);game.stage.update()};createjs.Ticker.addEventListener("tick",h)},i=function(){var e=20,t=100,a=10,r=20,s=.04,n=.08,i=.3,c=.001,o=new createjs.Container;game.stage.addChild(o);var l=[];createjs.Ticker.addEventListener("tick",function(){if(!userCtrl.paused){if(Math.random()<i){var u=e+Math.random()*(t-e),d=a+Math.random()*(r-a),g=s+Math.random()*(n-s),h=generateRound("black",u,u+d).set({x:Math.random()*WIDTH,y:Math.random()*HEIGHT,alpha:0});o.addChild(h),l.push({s:h,isAdd:!0,a:g})}for(var m=0;m<l.length;m++){var f=l[m];f.isAdd?(f.s.alpha+=c,f.s.alpha>=f.a&&(f.isAdd=!1)):f.s.alpha-=c,f.s.alpha<0&&(o.removeChild(f.s),l.splice(m,1),m--)}}})},c=function(){game.settings.levelReached<e&&(game.settings.levelReached=e),game.saveSettings();var t=ME_HP_MAX[game.settings.difficulty],a=t,r=parseMap(e),s=null;s=r.white?generatePerson("#000"):generatePerson("#808080");var n=r.lights;userCtrlReset(),createjs.Ticker.addEventListener("tick",function(){game.focused||userCtrl.paused||(pause(),userCtrl.up=!1,userCtrl.down=!1,userCtrl.left=!1,userCtrl.right=!1)});var o=function(e){createjs.Ticker.removeAllEventListeners("tick");var t=(new createjs.Shape).set({alpha:0});t.graphics.f("black").r(0,0,WIDTH,HEIGHT),game.stage.addChild(t);var a=function(){return t.alpha>=1?(createjs.Ticker.removeEventListener("tick",a),game.stage.removeAllChildren(),e(),void 0):(t.alpha+=.02,game.stage.update(),void 0)};createjs.Ticker.addEventListener("tick",a)},l=function(){o(c)},u=function(){game.settings.curLevel++,o(function(){startLevel(game.settings.curLevel)})},d=function(e){0>e?o(function(){startLevel(-1)}):(game.settings.curLevel=e,game.saveSettings(),o(function(){startLevel(game.settings.curLevel)}))},g=new createjs.Container;g.addChild(new createjs.Shape((new createjs.Graphics).f("rgba(0,0,0,0.7)").r(0,0,WIDTH,HEIGHT)));var h=new createjs.Container;g.addChild(h),h.x=WIDTH/2-250,h.y=HEIGHT/2-150;var m=new createjs.Shape((new createjs.Graphics).f("rgba(255,255,255,0.7)").r(0,0,500,300)).set({filters:[new createjs.BoxBlurFilter(10,10,1)]});m.cache(-10,-10,520,320),h.addChild(m),h.addChild(new createjs.Shape((new createjs.Graphics).f("rgba(64,64,64,0.7)").r(30,80,440,3))),h.addChild(new createjs.Text(game.str[23],"20px"+game.lang.font,"black").set({textAlign:"center",textBaseline:"top",x:250,y:40})),h.addChild(new createjs.Text(game.str[24],"16px"+game.lang.font,"rgb(64,64,64)").set({textAlign:"center",textBaseline:"bottom",x:250,y:270}));var f=new createjs.Container;h.addChild(f);var v=0,p=function(e,t,a,r){r?f.addChild(new createjs.Shape((new createjs.Graphics).ss(2).s("rgb(128,128,128)").f("rgb(128,128,128)").r(-20+e,-20+t,40,40))):f.addChild(new createjs.Shape((new createjs.Graphics).ss(2).s("rgb(128,128,128)").r(-20+e,-20+t,40,40))),f.addChild(new createjs.Text(a,"16px"+game.lang.font,"black").set({textAlign:"center",textBaseline:"middle",x:e,y:t}))},C=function(){f.removeAllChildren(),p(75,120,0,!v);for(var e=1;e<=game.settings.levelReached;e++){var t=Math.floor((e-1)/6)+1,a=(e-1)%6+2;19===e&&(t=3,a=8),p(50*a+25,50*t+70,e,e===v)}},E=!1,M=3;createjs.Ticker.addEventListener("tick",function(){return userCtrl.paused&&!E?(game.stage.addChild(g),E=!0,game.settings.musicOn&&createjs.Sound.setVolume(.003*game.settings.volume),v=game.settings.curLevel,C(),game.stage.update()):!userCtrl.paused&&E&&(game.stage.removeChild(g),E=!1,game.settings.musicOn&&createjs.Sound.setVolume(game.settings.volume/100)),userCtrl.paused?(M--,M||(M=3,userCtrl.up&&v>=7&&18>=v&&(v-=6),userCtrl.down&&v>=1&&12>=v&&v<=game.settings.levelReached-6&&(v+=6),userCtrl.left&&v>=1&&v--,userCtrl.right&&v<game.settings.levelReached&&v++,(userCtrl.up||userCtrl.down||userCtrl.left||userCtrl.right)&&(C(),game.stage.update()),userCtrl.skip?(userCtrl.skip=!1,v===game.settings.curLevel?setTimeout(function(){unpause(),game.settings.musicOn&&createjs.Sound.setVolume(game.settings.volume/100)},0):setTimeout(function(){unpause(),game.settings.musicOn&&createjs.Sound.setVolume(game.settings.volume/100),d(v)},0)):userCtrl.reset&&(userCtrl.reset=!1,setTimeout(function(){unpause(),game.settings.musicOn&&createjs.Sound.setVolume(game.settings.volume/100),d(-1)},0))),void 0):(userCtrl.skip=!1,void 0)}),createjs.Ticker.addEventListener("tick",function(){!userCtrl.paused&&userCtrl.reset&&(l(),userCtrl.reset=!1)}),createjs.Ticker.addEventListener("tick",function(){if(!userCtrl.paused){userCtrl.action&&e>1&&(a-=ME_ACTION_DAMAGE);for(var t=0;t<n.length;t++){var i=n[t],c=i.x-s.x,o=i.y-s.y,d=Math.sqrt(c*c+o*o)-ME_R;d<=i.r&&(a-=i.r-d>2*ME_R?2*ME_R*ME_DAMAGE_PER_R:(i.r-d)*ME_DAMAGE_PER_R)}0>=a&&l();var c=r.endX-s.x,o=r.endY-s.y;4*ME_R*ME_R>=c*c+o*o&&u()}});var w=!1;if(createjs.Ticker.addEventListener("tick",function(){if(!userCtrl.paused){var t=0,a=0;if(userCtrl.up&&a--,userCtrl.down&&a++,userCtrl.left&&t--,userCtrl.right&&t++,userCtrl.action&&e>1){if(w||(w=!0,s.gotoAndPlay("fast")),0!==t||0!==a){var n=0;0===a&&1===t?n=0:0===a&&-1===t?n=Math.PI:0===t?n=Math.PI/2:-1===t?n=3*Math.PI/4:1===t&&(n=Math.PI/4),-1===a&&(n=-n),n+=2*Math.random()*ME_ACTION_DIF-ME_ACTION_DIF,t=ME_ACTION_SPEED*Math.cos(n),a=ME_ACTION_SPEED*Math.sin(n)}}else w&&(w=!1,s.gotoAndPlay("normal")),t*=ME_MOVE_SPEED,a*=ME_MOVE_SPEED,0!==t&&0!==a&&(t/=1.4142136,a/=1.4142136);if(t||a){var i=s.x+t,c=s.y+a,o=function(e,t){return ME_R>e||ME_R>t||e>=WIDTH-ME_R||t>=HEIGHT-ME_R?!0:r.block[Math.floor(e/6)+160*Math.floor(t/6)]};o(i,c)&&(o(s.x+t,s.y)?o(s.x,s.y+a)?(t>0?i=6*Math.floor(i/6)-.001:0>t&&(i=6*(Math.floor(i/6)+1)),a>0?c=6*Math.floor(c/6)-.001:0>a&&(c=6*(Math.floor(c/6)+1))):t>0?i=6*Math.floor(i/6)-.001:0>t&&(i=6*(Math.floor(i/6)+1)):a>0?c=6*Math.floor(c/6)-.001:0>a&&(c=6*(Math.floor(c/6)+1))),s.x=i,s.y=c}}}),r.white&&(game.stage.addChild(r.picture),game.stage.addChild(whiteMap)),game.stage.addChild(s),s.x=r.startX,s.y=r.startY,s.gotoAndPlay("normal"),r.white||game.stage.addChild(r.picture),r.showEnd||r.alwaysShowEnd){var j=generatePerson("#FBB7BF");if(game.stage.addChild(j),j.x=r.endX,j.y=r.endY,j.gotoAndPlay("normal"),r.showEnd){j.alpha=4;var T=function(){userCtrl.paused||(j.alpha-=.02,j.alpha<=0&&(createjs.Ticker.removeEventListener("tick",T),game.stage.removeChild(j)))};createjs.Ticker.addEventListener("tick",T)}}var k=(new createjs.Container).set({x:0,y:0});game.stage.addChild(k);var S=LIGHTS_SPEED[game.settings.difficulty];if(createjs.Ticker.addEventListener("tick",function(){if(!userCtrl.paused){k.removeAllChildren();for(var e=0;e<n.length;e++){var t=n[e],a=.5;if(t.rmax>t.rmin&&Math.random()<2*P_STATE_CHANGE[game.settings.difficulty]){var r=Math.random();if(a>r){var s=(t.r-t.rmin)/(t.rori-t.rmin);t.rori===t.rmin&&(s=1e6*(t.r-t.rmin));var i=(t.r-t.rmax)/(t.rori-t.rmax);t.rori===t.rmax&&(i=1e6*(t.r-t.rmax)),t.sizeState=s/(s+i)>r/a?-Math.random()*S*t.speed:Math.random()*S*t.speed}else t.sizeState=0}if(t.r+=t.sizeState,t.r>=t.rmax&&(t.r=t.rmax),t.r<=t.rmin&&(t.r=t.rmin),t.area){if(Math.random()<P_STATE_CHANGE[game.settings.difficulty]){var r=2*Math.random()*Math.PI,c=Math.random()*t.area,o=Math.cos(r)*c+t.xori,l=Math.sin(r)*c+t.yori,u=Math.sqrt((o-t.x)*(o-t.x)+(l-t.y)*(l-t.y));t.moveX=(o-t.x)*S*t.speed/u,t.moveY=(l-t.y)*S*t.speed/u}t.x+=t.moveX,t.y+=t.moveY,(t.x-t.xori)*(t.x-t.xori)+(t.y-t.yori)*(t.y-t.yori)>t.area*t.area&&(t.x-=t.moveX,t.y-=t.moveY,t.moveX=0,t.moveY=0)}k.addChild(generateLight(Math.round(t.r),t.x,t.y))}}}),MOBILE||i(),e>0){var x=new createjs.Shape;x.graphics.f("black").r(0,0,8,100),x.filters=[new createjs.BoxBlurFilter(3,3,1)],x.cache(-7,-7,22,114);var y=new createjs.Shape;y.graphics.ss(1).s("#fff").f("black").r(0,0,8,100),y.cache(0,0,8,100);var _=new createjs.Shape;_.graphics.f("#fff").r(0,0,8,100);var A=(new createjs.Container).set({x:50,y:50,alpha:.3});r.white&&(whiteMap.alpha=1.3-A.alpha),A.addChild(x),A.addChild(y),A.addChild(_),game.stage.addChild(A);var I=a,H=0,L=.03;createjs.Ticker.addEventListener("tick",function(){if(!userCtrl.paused){if(A.alpha<=.3&&(H=0),I>a){I=a;var e=100*a/t;e>0?_.graphics.c().f("#fff").r(0,100-e,8,e):_.graphics.c(),0>=H&&(H=1)}A.alpha>=.8&&(H=-1),1===H?(A.alpha+=L,r.white&&(whiteMap.alpha=1.3-A.alpha)):-1===H&&(A.alpha-=L,r.white&&(whiteMap.alpha=1.3-A.alpha))}})}var R=(new createjs.Shape).set({alpha:1});R.graphics.f("black").r(0,0,WIDTH,HEIGHT),game.stage.addChild(R);var P=function(){return userCtrl.paused?void 0:R.alpha<=0?(createjs.Ticker.removeEventListener("tick",P),game.stage.removeChild(R),void 0):(R.alpha-=.04,void 0)};if(createjs.Ticker.addEventListener("tick",P),createjs.Ticker.addEventListener("tick",function(){userCtrl.paused||game.stage.update()}),game.words[e].hint&&hint.show(game.words[e].hint,5e3),DEBUG.SHOW_FPS){var D=new createjs.Text("FPS: ...","12px monospace","red");D.x=0,D.y=0,game.stage.addChild(D),createjs.Ticker.addEventListener("tick",function(){D.text="FPS: "+Math.round(createjs.Ticker.getMeasuredFPS())})}}};game.started=!1,game.start=function(){if(!game.started){game.started=!0;var e=function(){game.settings.musicOn?(createjs.Sound.setVolume(game.settings.volume/100),hint.show(game.str[25]+game.settings.volume,1e3)):(createjs.Sound.setVolume(0),hint.show(game.str[26],1e3)),game.saveSettings()},t=function(){userCtrl.paused?unpause():pause()},a=function(){userCtrl.reset=!0},r=function(){game.settings.musicOn=!game.settings.musicOn,e()},s=function(){game.settings.volume<100&&(game.settings.volume+=10),e()},n=function(){game.settings.volume>0&&(game.settings.volume-=10),e()},i=function(){userCtrl.skip=!0},c=function(){userCtrl.action=!0},o=function(){userCtrl.up=!0},l=function(){userCtrl.down=!0},u=function(){userCtrl.left=!0},d=function(){userCtrl.right=!0},g=function(){userCtrl.action=!1},h=function(){userCtrl.up=!1},m=function(){userCtrl.down=!1},f=function(){userCtrl.left=!1},v=function(){userCtrl.right=!1},p={32:c,38:o,87:o,40:l,83:l,37:u,65:u,39:d,68:d},C={19:t,27:t,80:t,77:r,188:n,190:s,13:i,82:a,32:g,38:h,87:h,40:m,83:m,37:f,65:f,39:v,68:v};MOBILE&&(game.mouseFuncRemove=function(){}),game.keyDownFunc=function(e){p[e.keyCode]&&(p[e.keyCode](),e.preventDefault())},window.addEventListener("keydown",game.keyDownFunc,!1),game.keyUpFunc=function(e){C[e.keyCode]&&(C[e.keyCode](),e.preventDefault())},window.addEventListener("keyup",game.keyUpFunc,!1),game.blurFunc=function(){pause()},game.stage.enableMouseOver(0),startLevel(game.settings.curLevel)}};