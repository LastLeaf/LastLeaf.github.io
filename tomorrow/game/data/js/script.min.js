// Copyright 2013 LastLeaf, MIT LICENSE
"use strict";!function(){var e={"JavaScript/JSON":function(){return"undefined"!=typeof JSON?!0:void 0},"DOM/Canvas":function(){try{if("undefined"!=typeof document.createElement("canvas").getContext)return!0}catch(e){}},"DOM/Audio":function(){try{if("undefined"!=typeof document.createElement("audio").src)return!0}catch(e){}},"DOM/AddEventListener":function(){return"undefined"!=typeof window.addEventListener?!0:void 0},"":function(){return!0}};window.HTML5Compatibility=function(){var n=function(){var n;n="array"==typeof arguments[0]?arguments[0]:arguments;for(var t=[],o=0;o<n.length;o++){var c=!1,u=n[o];if(!e[u])throw new Error("Unrecognized compatibility test item: "+n[o]);e[u]()&&(c=!0),c||t.push(n[u])}return t},t=function(){for(var n in e)if(!e[n]())return!1;return!0};return{unsupported:n,supportAll:t}}()}(),function(){if(!document.bindReady){var e=[],n=function(){if(null!==e){for(var n=0;n<e.length;n++)e[n].call(window);e=null}};document.addEventListener?document.addEventListener("DOMContentLoaded",function t(){document.removeEventListener("DOMContentLoaded",t,!1),n()},!1):document.attachEvent?(document.attachEvent("onreadystatechange",function o(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",o),n())}),document.documentElement.doScroll&&window==window.top&&function c(){if(null!==e){try{document.documentElement.doScroll("left")}catch(t){return setTimeout(c,0),void 0}n()}}()):window.onload=n,document.bindReady=function(n){null!==e?e.push(n):n.call(window)}}}(),window.textToHtml=function(e){return String(e).replace(/\&/,"&amp;").replace(/\</,"&lt;").replace(/\>/,"&gt;").replace(/(\r|\n|\r\n)/,"<br>")},document.bindReady(function(){window.hint=function(){var e=8,n=40,t=document.getElementById("hint"),o=0,c=!0,u=!1,r=!1,l=function(){c?(o+=e,o>0&&(o=0,clearInterval(u),u=!1),t.style.top=o+"px"):(o-=e,o<=-t.clientHeight&&(t.style.display="none",clearInterval(u),u=!1),t.style.top=o+"px")},d=function(){u||(u=setInterval(l,n))},i=function(e,n){t.innerHTML=textToHtml(e),c||(c=!0,t.style.display="block",o=-t.clientHeight,t.style.top=o+"px",d()),r&&(clearTimeout(r),r=!1),n&&(r=setTimeout(m,n))},a=function(e,n){i(e),t.innerHTML='<a href="'+n+'" target="_blank">'+t.innerHTML+"</a>"},m=function(){c&&(c=!1,d()),r&&(clearTimeout(r),r=!1)};return{show:i,showLink:a,hide:m}}()}),document.bindReady(function(){var e=document.getElementById("wrapper");e.ondblclick=function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}});
"use strict";var FPS=32,WIDTH=960,HEIGHT=540,USE_ADVANCED_LOADING=!1,STORAGE_ID="tomorrow",STORAGE_VERSION=VERSION,DEFAULT_SETTINGS={version:STORAGE_VERSION,musicOn:!0,volume:100,curLevel:0,levelReached:0,difficulty:1,langs:""};window.game={},game.settings=null,game.stage=null,game.curMusic=-1,game.focused=!0;var initResource=null;game.saveSettings=function(){localStorage[STORAGE_ID]=JSON.stringify(game.settings)},game.createTextButton=function(e,t,a,i,n,s){var o=new createjs.Container,r=new createjs.Text(e,t+"px"+game.lang.titleFont,"#888"),g=new createjs.Text(e,t+"px"+game.lang.titleFont,"#00d2ff"),l=new createjs.Shape,m=r.getMeasuredWidth()+5,d=r.getMeasuredHeight()+5;return l.graphics.s(a).f(a).r(-m/2,-d/2,m,d),o.addChild(l,r,g),r.lineHeight=d,g.lineHeight=d,r.textAlign="center",g.textAlign="center",r.textBaseline="middle",g.textBaseline="middle",g.visible=!1,o.x=i,o.y=n,o.addEventListener("mouseover",function(){g.visible=!0,r.visible=!1}),o.addEventListener("mouseout",function(){r.visible=!0,g.visible=!1}),o.addEventListener("click",s),o},game.showCover=function(){var e=initResource;createjs.Ticker.setFPS(FPS),game.stage.enableMouseOver(FPS);var t=new createjs.Container;t.x=WIDTH/2,t.y=HEIGHT-30,game.stage.addChild(t);var a=new createjs.Container,i=new createjs.Shape;if(i.graphics.s("black").f("black").r(-5,-5,154,58),a.addChild(i,new createjs.Bitmap(e.getResult("lastleaf_grey")),new createjs.Bitmap(e.getResult("lastleaf"))),a.getChildAt(1).alpha=.8,a.getChildAt(2).visible=!1,a.x=-370,a.y=-26,a.addEventListener("mouseover",function(){a.getChildAt(2).visible=!0,a.getChildAt(1).visible=!1}),a.addEventListener("mouseout",function(){a.getChildAt(1).visible=!0,a.getChildAt(2).visible=!1}),a.addEventListener("click",function(){"resource:"!==location.protocol&&window.open("http://lastleaf.mistymiracle.org/")}),t.addChild(a),"kongregate"===PLATFORM)var n=game.createTextButton("KONGREGATE",16,"#000",260,0,function(){window.open("http://www.kongregate.com/")});else var n=game.createTextButton(game.str[3],16,"#000",270,0,function(){"resource:"!==location.protocol?window.open("license_"+game.settings.lang+".html"):location.href="license_"+game.settings.lang+".html?showback"});t.addChild(n);var s=game.createTextButton("v1.0.0",16,"#000",350,0,function(){"resource:"!==location.protocol?window.open("change_logs.html"):location.href="change_logs.html?showback"});t.addChild(s);var o=game.createTextButton(game.str[4],16,"#000",0,0,function(){"resource:"!==location.protocol&&window.open("http://blog.programet.org/2010/04/%E6%98%8E%E5%A4%A9.html")});t.addChild(o),document.title="zh-CN"===game.settings.lang?"明天 | LastLeaf":"Tomorrow | LastLeaf";var r=new createjs.Bitmap(e.getResult("title"));game.stage.addChild(r),r.x=r.cx=(WIDTH-r.image.width)/2,r.y=r.cy=40,r.alpha=.8;var g=new createjs.Container,l=new createjs.Shape;l.graphics.f("#222").r(0,0,800,3);var m=new createjs.Shape,d=m.graphics;d.f("#888").r(0,0,0,3);var c=new createjs.Text(game.str[5],"20px"+game.lang.titleFont,"#888");c.textAlign="center",c.textBaseline="middle",c.x=400,c.y=53,g.addChild(l,m,c),game.stage.addChild(g),g.textAlign="center",g.x=(WIDTH-800)/2,g.y=277,g.isAlphaUp=!1;var u=function(e,t,a,i){var n=2*(Math.random()-.5)*a+t;return(n-e)*i+e},h=!1,v=function(){r.x=u(r.x,r.cx,8,.06),r.y=u(r.y,r.cy,8,.06),r.alpha=u(r.alpha,.75,.25,.25),g.isAlphaUp?(g.alpha+=.02,g.alpha>=1&&(g.isAlphaUp=!1)):(g.alpha-=.02,g.alpha<=.5&&(g.isAlphaUp=!0)),(game.focused||!h)&&(game.stage.update(),h=game.mainResource?!0:!1)};createjs.Ticker.addEventListener("tick",v);var p=function(e){var t=game.mainResource=e.target;d.c().f("#888").r(0,0,800,3),document.title="zh-CN"===game.settings.lang?"明天 | LastLeaf":"Tomorrow | LastLeaf",r.image=t.getResult("tomorrow"),"file:"!==location.protocol&&"resource:"!==location.protocol&&(game.maps=t.getResult("maps").split("\n"),game.words=t.getResult("words"));var a=function(e){game.settings.lang=e,game.saveSettings(),game.lang=game.langs[e],game.str=game.lang.str,createjs.Ticker.removeAllEventListeners("tick"),window.removeEventListener("keyup",h),game.stage.removeAllChildren(),game.mainResource=null,game.showCover()};if("zh-CN"===game.settings.lang)var i=game.createTextButton("English",20,"#000",WIDTH/2,450,function(){a("en")});else var i=game.createTextButton("简体中文",20,"#000",WIDTH/2,450,function(){a("zh-CN")});var n=[game.createTextButton(game.str[6],20,"#000",WIDTH/2,410,function(){n[0].visible=!1,n[1].visible=!0,game.settings.difficulty=1,n[1].dispatchEvent("mouseover")}),game.createTextButton(game.str[7],20,"#000",WIDTH/2,410,function(){n[1].visible=!1,n[2].visible=!0,game.settings.difficulty=2,n[2].dispatchEvent("mouseover")}),game.createTextButton(game.str[8],20,"#000",WIDTH/2,410,function(){n[2].visible=!1,n[3].visible=!0,game.settings.difficulty=3,n[3].dispatchEvent("mouseover")}),game.createTextButton(game.str[9],20,"#000",WIDTH/2,410,function(){n[3].visible=!1,n[0].visible=!0,game.settings.difficulty=0,n[0].dispatchEvent("mouseover")})];n[0].addEventListener("mouseover",function(){hint.show(game.str[10],3e3)}),n[1].addEventListener("mouseover",function(){hint.show(game.str[11],3e3)}),n[2].addEventListener("mouseover",function(){hint.show(game.str[12],3e3)}),n[3].addEventListener("mouseover",function(){hint.show(game.str[13],3e3)}),n[0].set({visible:!1}).addEventListener("mouseout",hint.hide),n[1].set({visible:!1}).addEventListener("mouseout",hint.hide),n[2].set({visible:!1}).addEventListener("mouseout",hint.hide),n[3].set({visible:!1}).addEventListener("mouseout",hint.hide),n[game.settings.difficulty].visible=!0;var s=game.createTextButton(game.str[14],20,"#000",WIDTH/2,370,function(){s.visible=!1,o.visible=!0,game.settings.musicOn=!1,o.dispatchEvent("mouseover")}),o=game.createTextButton(game.str[15],20,"#000",WIDTH/2,370,function(){o.visible=!1,s.visible=!0,game.settings.musicOn=!0,s.dispatchEvent("mouseover")}),l=function(){hint.show(game.str[16],3e3)};if(s.addEventListener("mouseover",l),o.addEventListener("mouseover",l),s.addEventListener("mouseout",hint.hide),o.addEventListener("mouseout",hint.hide),game.settings.musicOn?(o.visible=!1,s.visible=!0):(s.visible=!1,o.visible=!0),game.settings.curLevel)var m=game.str[17];else var m=game.str[18];var u=game.createTextButton(m,20,"#000",WIDTH/2,330,function(){game.saveSettings(),window.removeEventListener("keyup",h);var e=new createjs.Shape;e.graphics.f("black").r(0,0,WIDTH,HEIGHT),e.alpha=.005,game.stage.addChild(e),createjs.Ticker.addEventListener("tick",function(){e.alpha>=1&&(createjs.Ticker.removeAllEventListeners("tick"),game.stage.removeAllChildren(),game.stage.update(),hint.hide(),game.start()),e.alpha+=.1})});u.addEventListener("mouseover",function(){game.settings.curLevel?hint.show(game.str[19].replace("%1",game.settings.curLevel),3e3):hint.show(game.str[20],3e3)}),u.addEventListener("mouseout",function(){hint.hide()}),i.alpha=0,n[0].alpha=0,n[1].alpha=0,n[2].alpha=0,n[3].alpha=0,s.alpha=0,o.alpha=0,u.alpha=0,g.removeChild(c),game.stage.addChild(i,n[0],n[1],n[2],n[3],s,o,u),createjs.Ticker.addEventListener("tick",function(){s.alpha>=1||(i.alpha+=.1,n[0].alpha+=.1,n[1].alpha+=.1,n[2].alpha+=.1,n[3].alpha+=.1,s.alpha+=.1,o.alpha+=.1,u.alpha+=.1)});var h=function(e){if(32===e.keyCode)u.dispatchEvent("mouseover"),u.dispatchEvent("click");else if(77===e.keyCode)s.visible?s.dispatchEvent("click"):o.dispatchEvent("click");else if(188===e.keyCode)game.settings.volume>0&&(game.settings.volume-=10),hint.show(game.str[22]+game.settings.volume,1e3);else if(190===e.keyCode)game.settings.volume<100&&(game.settings.volume+=10),hint.show(game.str[22]+game.settings.volume,1e3);else{if(82!==e.keyCode)return;confirm(game.str[21])&&(delete localStorage[STORAGE_ID],game.stage.removeAllChildren(),createjs.Ticker.removeAllEventListeners("tick"),window.removeEventListener("keyup",h),game.showCover())}e.preventDefault()};window.addEventListener("keyup",h)};if(game.mainResource)p({target:game.mainResource});else{var f=new createjs.LoadQueue(USE_ADVANCED_LOADING,"data/");if(f.installPlugin(createjs.Sound),f.addEventListener("progress",function(e){d.c().f("#888").r(0,0,800*e.progress,3)}),f.addEventListener("complete",p),"file:"!==location.protocol&&"resource:"!==location.protocol)f.loadManifest([{id:"maps",type:"text",src:"maps.data?v="+VERSION},{id:"words",src:"words_"+game.settings.lang+".json?v="+VERSION},{id:"bgm1",src:"audio/the_start_of_night.ogg|audio/the_start_of_night.mp3"},{id:"bgm2",src:"audio/tomorrow.ogg|audio/tomorrow.mp3"},{id:"bgm3",src:"audio/spreading_white.ogg|audio/spreading_white.mp3"},{id:"bgm4",src:"audio/tomorrow_short.ogg|audio/tomorrow_short.mp3"},{id:"tomorrow",src:"image/title_"+game.settings.lang+".png"},{src:"js/levels.js?v="+VERSION}]);else{var E=new XMLHttpRequest;E.addEventListener("load",function(){game.maps=E.response.split("\n")},!1),E.open("GET","data/maps.data",!1),E.overrideMimeType("text/plain; charset=utf8"),E.send();var w=new XMLHttpRequest;w.addEventListener("load",function(){game.words=JSON.parse(w.response)},!1),w.open("GET","data/words_"+game.settings.lang+".json",!1),w.overrideMimeType("text/plain; charset=utf8"),w.send(),f.loadManifest([{id:"bgm1",src:"audio/the_start_of_night.ogg|audio/the_start_of_night.mp3"},{id:"bgm2",src:"audio/tomorrow.ogg|audio/tomorrow.mp3"},{id:"bgm3",src:"audio/spreading_white.ogg|audio/spreading_white.mp3"},{id:"bgm4",src:"audio/tomorrow_short.ogg|audio/tomorrow_short.mp3"},{id:"tomorrow",src:"image/title_"+game.settings.lang+".png"},{src:"js/levels.js"}])}}};var startResizeWrapper=function(){var e=document.getElementById("wrapper"),t=document.getElementById("main_canvas"),a=function(){e.style.height=document.documentElement.clientHeight+"px";var a=1;if(document.documentElement.clientHeight<HEIGHT)var a=document.documentElement.clientHeight/HEIGHT;if(document.documentElement.clientWidth<WIDTH){var i=document.documentElement.clientWidth/WIDTH;a>i&&(a=i)}a>=1?(t.style.width=WIDTH+"px",t.style.height=HEIGHT+"px"):(t.style.width=Math.round(WIDTH*a)+"px",t.style.height=Math.round(HEIGHT*a)+"px")};window.onresize=a,a()};document.bindReady(function(){try{if(game.settings=JSON.parse(localStorage[STORAGE_ID]),game.settings.version!==STORAGE_VERSION){for(var e in DEFAULT_SETTINGS)"undefined"==typeof game.settings[e]&&(game.settings[e]=DEFAULT_SETTINGS[e]);game.settings.version=STORAGE_VERSION,game.saveSettings()}}catch(t){game.settings=DEFAULT_SETTINGS}if(game.settings.lang||(game.settings.lang="zh-CN"===navigator.language||"zh-CN"===navigator.userLanguage?"zh-CN":"en"),game.lang=game.langs[game.settings.lang],game.str=game.lang.str,hint.show(game.str[0]),!HTML5Compatibility.supportAll())return hint.showLink(game.str[1],GAME_HOME_PAGE[game.settings.lang]),void 0;try{game.saveSettings(),JSON.parse(localStorage[STORAGE_ID])}catch(t){return hint.showLink(game.str[27],location.href),void 0}window.addEventListener("focus",function(){game.focused=!0},!1),window.addEventListener("blur",function(){game.focused=!1},!1),document.getElementById("wrapper").innerHTML='<canvas id="main_canvas" width="'+WIDTH+'" height="'+HEIGHT+'"></canvas>',startResizeWrapper(),game.stage=new createjs.Stage("main_canvas"),createjs.Sound.registerPlugins([createjs.HTMLAudioPlugin]),hint.show(game.str[2]);var a=new createjs.LoadQueue(USE_ADVANCED_LOADING,"data/");a.addEventListener("complete",function(){hint.hide(),initResource=a,game.showCover()}),a.loadManifest([{id:"title",src:"image/title_"+game.settings.lang+".png"},{id:"lastleaf",src:"image/lastleaf.png"},{id:"lastleaf_grey",src:"image/lastleaf_grey.png"}])});
game.langs={"zh-CN":{titleFont:' "文泉驿正黑","微软雅黑" ',font:' "文泉驿正黑","微软雅黑","黑体" ',storyFontSize:30,str:["正在检测浏览器兼容性……","你的浏览器不支持本游戏，点这里查看解决方案","正在载入页面……","授权协议","改编自同名短篇小说","正在加载资源……","难度：傻瓜","难度：新手","难度：勇士","难度：疯子","你真的是傻瓜吗？","如果未曾通关，这个难度比较合适吧……","这是个挑战！","你不可能通关的，除非你疯了。","音乐：开","音乐：关","“M”键可以开关音乐，“<”和“>”键调节音量","继续游戏","开始游戏","游戏已进行至第 %1 关，按“R”键可清除游戏进度","开始新的游戏（你的游戏进度会被自动保存）","清除游戏进度和游戏设置？","音量：","已暂停，按“P”键继续","按方向键或WASD选择关卡，Enter跳转，“R”键返回封面","音乐已经打开，音量：","音乐已经关闭","浏览器阻止了游戏的一部分功能，点这里尝试解决这个问题"]},en:{titleFont:' "sans-serif" ',font:' "sans-serif" ',storyFontSize:28,str:["Detecting browser compatibilities...","Your browser does not support this game. Click here to see the solution.","Loading page content...","LICENSE","Base on Short Story of the Same Title","Loading...","Difficulty: Idiot","Difficulty: Beginner","Difficulty: Warrior","Difficulty: Madman","ARE YOU SURE???","Good for you if you are new to this game...","It's a challenge!","You'll never get through unless you're mad.","Music: On","Music: Off","Press [M] to turn on/off music; [<] and [>] to adjust the volume.","Continue","Start Game","You are at Level %1. Press [R] to clear the present game progress.","Start a new game. Your game progress will be auto-saved.","Clear the present game progress and settings?","Volume: ","Paused. Press [P] to continue...","Press WASD or arrow keys and [Enter] to select levels.","Music is on. Volume: ","Music is off.","Your browser prevented some features of this game. Click here to try fixing."]}};